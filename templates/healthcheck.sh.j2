#/bin/bash

{{ ansible_managed | comment }}

LOG=/var/log/healthcheck.log
ERROR_LOG=/var/log/healthcheck.error.log

date >> "$LOG"
date >> "$ERROR_LOG"

if RESULT=$(2>&1 {{ healthchecks_command }}); then
    URI=''
else
    URI='/fail'
fi

all_proxy=socks5://127.0.0.1:{{ socks_direct_port }} \
    curl -fsS --retry 3 -X POST -d "$RESULT" \
        "https://hc-ping.com/{{ healthchecks_uuid }}$URI" \
        >> "$LOG" \
        2>> "$ERROR_LOG"

echo >> "$LOG"
echo >> "$ERROR_LOG"
