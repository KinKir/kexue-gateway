- name: Generate v2ray config file to remote
  template:
    src: config.json.j2
    dest: /tmp/v2ray-config.json
    mode: 0644
  register: generate_v2ray_config
  notify:
    - restart v2ray

- name: Validate configuration
  shell: "/usr/bin/v2ray/v2ray -test -config {{ generate_v2ray_config.invocation.module_args.dest }}"
  changed_when: false

- name: Copy config file after validation passed
  copy:
    remote_src: true
    src: "{{ generate_v2ray_config.invocation.module_args.dest }}"
    dest: /etc/v2ray/config.json

- name: Trigger handlers
  meta: flush_handlers

- name: Ensure v2ray service is running
  shell: service v2ray status
  changed_when: false
  args:
    warn: false
